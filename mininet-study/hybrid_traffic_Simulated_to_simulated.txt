################################################################################
#                                 PC1 Scripts
################################################################################

#(Routing)
#h1 ---- h2 ---- (bridge) physical (bridge) --- h3 --- h4

sudo ip link add h1-eth0 type veth peer name h2-eth0
sudo ip link add h2-eth1 type veth peer name phy1-eth0

sudo ip netns add h1
sudo ip netns add h2

sudo ip link set h1-eth0 netns h1
sudo ip link set h2-eth0 netns h2
sudo ip link set h2-eth1 netns h2

sudo ip netns exec h1 ifconfig lo up
sudo ip netns exec h2 ifconfig lo up

sudo ip netns exec h1 ifconfig h1-eth0 10.10.1.2/24
sudo ip netns exec h2 ifconfig h2-eth0 10.10.1.1/24
sudo ip netns exec h2 ifconfig h2-eth1 10.10.2.1/24

sudo ip netns exec h2 sysctl -w net.ipv4.ip_forward=1
sudo ip netns exec h2 ip route add 10.10.3.0/24 via 10.10.2.2
sudo ip netns exec h1 ip route add 10.10.3.0/24 via 10.10.1.1
sudo ip netns exec h1 ip route add 192.168.0.0/16 via 10.10.1.1
sudo ip netns exec h1 ip route add 192.170.0.0/16 via 10.10.1.1



#Write the following block in a file and run the file in background mode or normal mode
sudo brctl addbr br0
sudo brctl addif br0 phy1-eth0
sudo brctl addif br0 eth0
sudo ifconfig eth0 down
sudo ifconfig phy1-eth0 down
sudo ifconfig eth0 0.0.0.0 up
sudo ifconfig phy1-eth0 0.0.0.0 up
sudo ifconfig br0 10.1.0.28/16
sudo ip route add default via 10.1.0.1
#End Block


#Now wait fot the connection
sudo ip netns exec h1 ping -c1 10.10.1.1
sudo ip netns exec h2 ping -c1 10.10.1.2
sudo ip netns exec h2 ping -c1 10.10.2.1





################################################################################
#                                  PC2 Scripts
################################################################################
#(Routing)
#h1 ---- h2 ---- (bridge) physical (bridge) --- h3 --- h4

sudo ip link add phy2-eth0 type veth peer name h3-eth0
sudo ip link add h3-eth1 type veth peer name h4-eth0
sudo ip netns add h3
sudo ip netns add h4
sudo ip link set h3-eth0 netns h3
sudo ip link set h3-eth1 netns h3
sudo ip link set h4-eth0 netns h4
sudo ip netns exec h3 ifconfig lo up
sudo ip netns exec h4 ifconfig lo up
sudo ip netns exec h3 ifconfig h3-eth0 10.10.2.2/24
sudo ip netns exec h3 ifconfig h3-eth1 10.10.3.1/24
sudo ip netns exec h4 ifconfig h4-eth0 10.10.3.2/24
sudo ip netns exec h3 sysctl -w net.ipv4.ip_forward=1
sudo ip netns exec h3 ip route add 10.10.1.0/24 via 10.10.2.1
sudo ip netns exec h4 ip route add 10.10.1.0/24 via 10.10.3.1
sudo ip netns exec h4 ip route add 192.168.0.0/16 via 10.10.3.1
sudo ip netns exec h4 ip route add 192.170.0.0/16 via 10.10.3.1


#Write the following block in a file and run the file in background mode or normal mode
sudo brctl addbr br0
sudo brctl addif br0 phy2-eth0
sudo brctl addif br0 eth0
sudo ifconfig eth0 down
sudo ifconfig phy2-eth0 down
sudo ifconfig eth0 0.0.0.0 up
sudo ifconfig phy2-eth0 0.0.0.0 up
sudo ifconfig br0 10.1.0.29/16
sudo ip route add default via 10.1.0.1
#End Block


sudo ip netns exec h3 ping -c1 10.10.3.1
sudo ip netns exec h4 ping -c1 10.10.3.2
sudo ip netns exec h3 ping -c1 10.10.2.1



########################################################################################
#                                      Compile
########################################################################################
#PC1(pollux): ~/expt/batching/HybridTCPTrafficPC1.java
#PC2(pollux): ~/expt/hybrid_traffic/HybridTCPTrafficPC2.java

#PC1 (on pollux - h1, h2) In /root/expt/hybrid_traffic/
root@pollux:~/expt/hybrid_traffic# java -DRUNTIME_ENV=[c_slave1,d_slave1,eth2,10.10.1.1,eth3,10.10.2.1] -DPORTAL_LINKS=c_slave1:eth2,topnet.right_net.r.portal_if_10_10_1_0,c_slave1:eth3,topnet.right_net.r.portal_if_10_10_2_0 -jar ~/primogeni/netscript/dist/jprime.jar create hybrid_tcp_sim_sim_test1 HybridTCPTrafficSimSimPc1.java 192.168.0.0/16



#PC2 (on castor - h3, h4) In /root/expt/hybrid_traffic/
java -DRUNTIME_ENV=[c_slave1,d_slave1,eth2,10.10.2.2,eth3,10.10.3.1] -DPORTAL_LINKS=c_slave1:eth2,topnet.portal_router.portal_if_10_10_3_0,c_slave1:eth3,topnet.center_router.portal_if_10_10_2_0 -jar ~/primogeni/netscript/dist/jprime.jar create hybrid_sim_sim_traffic_test1 SolvingPortalTCP2.java 192.170.0.0/16



#PC1 Pollux: Now disable ip forwarding and run simulator and test ping again through simulator
sudo ip netns exec h2 sysctl -w net.ipv4.ip_forward=0
#PC2 castor
sudo ip netns exec h3 sysctl -w net.ipv4.ip_forward=0


sudo ip netns exec h1 ping -c1 10.10.3.2
#Shouldnt work
#sudo ip netns exec h4 ping -c1 10.10.1.2
#Shouldnt work


########################################################################################
#						 RUN
########################################################################################

Ping:
sudo ip netns exec h2 ping 10.10.2.2
sudo ip netns exec h3 ping 10.10.2.1


							#PC1(on pollux - h2)
sudo ip netns exec h2 sysctl -w net.ipv4.ip_forward=0
sudo ip netns exec h2 /root/primogeni_batch_portal/netsim/primex -tp 10.10.2.1 271 -tp 10.10.1.1 274 1800 hybrid_tcp_sim_sim_test1_part_1.tlv

#Route zzz
sudo ip netns exec h2 ifconfig h2-eth1 down
sudo ip netns exec h2 ifconfig h2-eth1 up
sudo ip netns exec h2 ip route del 10.10.3.0/24
sudo ip netns exec h2 ip route del 192.170.0.0/24
sudo ip netns exec h2 ip route add 10.10.3.0/24 via 10.10.2.2
sudo ip netns exec h2 ip route add 192.170.0.0/16 via 10.10.2.2
sudo ip netns exec h1 ip route add 192.168.0.0/16 via 10.10.1.1
sudo ip netns exec h1 ip route
sudo ip netns exec h2 ip route




							#PC2(on castor - h3)
sudo ip netns exec h3 sysctl -w net.ipv4.ip_forward=0
sudo ip netns exec h3 /root/primogeni/netsim/primex -tp 10.10.2.2 56 -tp 10.10.3.1 84 1800 hybrid_sim_sim_traffic_test1_part_1.tlv

#Route zzz
sudo ip netns exec h3 ifconfig h3-eth0 down
sudo ip netns exec h3 ifconfig h3-eth0 up
sudo ip netns exec h3 ip route del 10.10.1.0/24
sudo ip netns exec h3 ip route add 10.10.1.0/24 via 10.10.2.1
sudo ip netns exec h3 ip route del 192.168.0.0/16
sudo ip netns exec h3 ip route add 192.168.0.0/16 via 10.10.2.1
sudo ip netns exec h3 ip route
sudo ip netns exec h4 ip route


#(on pollux)
sudo ip netns exec h2 ping -c1 10.10.2.2

#castor
sudo ip netns exec h3 ping -c1 10.10.2.1

#Test PC2 castor
sudo ip netns exec h1 ping 10.10.1.1
sudo ip netns exec h1 ping 192.168.0.1
sudo ip netns exec h2 ping 10.10.2.2




#Test PC2 castor
sudo ip netns exec h4 ping 10.10.3.1
sudo ip netns exec h4 ping 192.170.0.1
sudo ip netns exec h4 ping 192.168.0.1



#Capture packet: vv for verbose and X for payload
sudo ip netns exec h4 tcpdump -nnvvXS > tmp.txt




#IPERF test:
#Server Pc1: 
sudo ip netns exec h1 iperf -s

#Client Pc2:
sudo ip netns exec h4 iperf -c 10.10.1.2






PC1 Results

root@pollux:~/expt/hybrid_traffic# sudo ip netns exec h2 /root/primogeni_batch_portal/netsim/primex -tp 10.10.1 271 -tp 10.10.1.1 274 60 hybrid_tcp_sim_sim_test1_part_1.tlv
------------------------------------------------------------
Parallel Real-time Immersive Simulation Environment (PRIME)
Scalable Simulation Framework (SSF) Version x1.0
Copyright (c) 2007-2011 Florida International University.
PRIME SSF is open source.
See COPYRIGHT for detailed licence information.
------------------------------------------------------------

============================================================
Parallel Real-time Immersive Simulation Environment (PRIME)
SSF Network Simulator (SSFNet) Version x1.0
Copyright (c) 2007-2011 Florida International University.
============================================================


using intial VEI of 500
Simulation time [0, 6e+10]
Dst ip is 192.170.0.1
[0] setup time: user = 0.01, system = 0
[0] DECADE LENGTH = 4.61169e+18
---> creating an active session, IP=192.168.0.1 srcport=2 dstport=80
topnet:left_net:h1:HTTPClient_0[29] is downloading 10485760 bytes from 0, time=30
timeout[uid=10,topnet:left_net:h1:HTTPClient_0] tcp session=8000002 throughput=0 MB/s total download time=0, start=0, end=0, total bytes recv=0 MB
[0]-------------- processor 0 --------------
[0](0)  CPU time: user = 28.44, system = 31.48
[0](0)  timelines = 1
[0](0)  entities = 1 (1 created here)
[0](0)  kernel events = 392
[0](0)  messages = 0 [xprc=0, xmem=0]
[0](0)  timeline context switches = 330
[0](0)  process context switches = 3
========================= summary ==========================
  execution time (max wall-clock time) = 60.0002
  CPU user time: total = 28.44, avg = 28.44
  total timelines = 1
  total entities = 1
  total kernel events = 392 (rate = 6.53331/sec)
  total messages = 0 (xprc=0, xmem=0)
  total timeline context switches = 330 (rate = 5.49998/sec)
  total process context switches = 3 (rate = 0.0499998/sec)



An inside simulation output:
---> creating an active session, IP=192.168.0.1 srcport=2 dstport=80
topnet:left_net:h1:HTTPClient_0[29] is downloading 100000000 bytes from 212, time=15
topnet:right_net:h2:HTTPServer_0[212] is sending 100000000, time=15.009
complete[uid=10,topnet:left_net:h1:HTTPClient_0] tcp_session_id=8000002 throughput=11.9887 MB/s totol download time=8.34118, start=15.0124, end=23.3536, total bytes recv=100 MB










PC2 castor results:

root@castor:~/expt/hybrid_traffic# sudo ip netns exec h3 /root/primogeni/netsim/primex -tp 10.10.2.2 56 -tp 10.10.3.1 84 1800 hybrid_sim_sim_traffic_test1_part_1.tlv
------------------------------------------------------------
Parallel Real-time Immersive Simulation Environment (PRIME)
Scalable Simulation Framework (SSF) Version x1.0
Copyright (c) 2007-2011 Florida International University.
PRIME SSF is open source.
See COPYRIGHT for detailed licence information.
------------------------------------------------------------

============================================================
Parallel Real-time Immersive Simulation Environment (PRIME)
SSF Network Simulator (SSFNet) Version x1.0
Copyright (c) 2007-2011 Florida International University.
============================================================


using intial VEI of 500
Simulation time [0, 1.8e+12]
sh: 1: /bin/awk: not found
RTNETLINK answers: File exists
sh: 1: /bin/awk: not found
RTNETLINK answers: File exists
[0] setup time: user = 0, system = 0.01
[0] DECADE LENGTH = 4.61169e+18
terminate called after throwing an instance of 'std::bad_alloc'
  what():  std::bad_alloc


root@castor:~/expt/hybrid_traffic# sudo ip netns exec h3 /root/primogeni/netsim/primex -tp 10.10.2.2 56 -tp 10.10.3.1 84 1800 hybrid_sim_sim_traffic_test1_part_1.tlv
------------------------------------------------------------
Parallel Real-time Immersive Simulation Environment (PRIME)
Scalable Simulation Framework (SSF) Version x1.0
Copyright (c) 2007-2011 Florida International University.
PRIME SSF is open source.
See COPYRIGHT for detailed licence information.
------------------------------------------------------------

============================================================
Parallel Real-time Immersive Simulation Environment (PRIME)
SSF Network Simulator (SSFNet) Version x1.0
Copyright (c) 2007-2011 Florida International University.
============================================================


using intial VEI of 500
Simulation time [0, 1.8e+12]
sh: 1: /bin/awk: not found
RTNETLINK answers: File exists
sh: 1: /bin/awk: not found
RTNETLINK answers: File exists
[0] setup time: user = 0, system = 0.01
[0] DECADE LENGTH = 4.61169e+18
Encountered stray packet from a closed session. pkt size=102
Encountered stray packet from a closed session. pkt size=102
Encountered stray packet from a closed session. pkt size=102
Encountered stray packet from a closed session. pkt size=102
Encountered stray packet from a closed session. pkt size=102



